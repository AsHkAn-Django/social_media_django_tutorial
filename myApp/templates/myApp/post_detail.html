{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load mptt_tags %}


{% block content %}
<div class="container mt-5">

    <!-- Post Details -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h2 class="card-title">{{ post.title }}</h2>
            <p class="card-text">{{ post.body }}</p>
            <p class="text-muted mb-0">
                <strong>Author:</strong> {{ post.author }} &nbsp;|&nbsp;
                <strong>Date:</strong> {{ post.date|date:"F j, Y, g:i a" }}
            </p>
        </div>
    </div>

  <!-- Comments -->
  <h4>Comments ({{ post.post_comments.count }})</h4>
  {% if post.post_comments.exists %}
    <ul class="list-group">
      {% recursetree post.post_comments.all %}
      <li class="list-group-item">
        <div class="comment">
          <strong>{{ node.user.username }}</strong>
          <small class="text-muted">at {{ node.created_at }}</small>
          <p>{{ node.body }}</p>
        </div>
        <a href="#" class="reply-link" data-comment-id="{{ node.id }}">Reply</a>
        <div id="reply-form-{{ node.id }}" style="display:none; margin-top:1rem;">
          <form method="post" action="{% url 'myApp:add_comment' post.pk %}">
            {% csrf_token %}
            <input type="hidden" name="parent_id" value="{{ node.id }}">
            {% bootstrap_field form.body %}
            <button type="submit" class="btn btn-sm btn-primary">Post Reply</button>
          </form>
        </div>
        {% if not node.is_leaf_node %}
          <ul class="list-group ml-4">
            {{ children }}
          </ul>
        {% endif %}
      </li>
      {% endrecursetree %}
    </ul>
  {% else %}
    <p>No comments yet.</p>
  {% endif %}

  <!-- Top-level comment form -->
  <div class="mt-4">
    <h5>Leave a Comment</h5>
    <form method="post" action="{% url 'myApp:add_comment' post.pk %}">
      {% csrf_token %}
      <input type="hidden" name="parent_id">
      {% bootstrap_field form.body %}
      <button type="submit" class="btn btn-primary">Post Comment</button>
    </form>
  </div>

<script>
// Simple JS to toggle reply forms
document.querySelectorAll('.reply-link').forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();
    const id = link.getAttribute('data-comment-id');
    const container = document.getElementById(`reply-form-${id}`);
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
  });
});
</script>
{% endblock %}
